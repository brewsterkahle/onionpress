#!/bin/bash

# onion.press launcher - Bootstraps Python environment and starts menu bar app

set -e

# Get directories
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
APP_DIR="$(dirname "$SCRIPT_DIR")"
RESOURCES_DIR="$APP_DIR/Resources"
SCRIPTS_DIR="$RESOURCES_DIR/scripts"
DATA_DIR="$HOME/.onion.press"
VENV_DIR="$DATA_DIR/venv"
BIN_DIR="$RESOURCES_DIR/bin"
COLIMA_HOME="$DATA_DIR/colima"

# Ensure data directory exists
mkdir -p "$DATA_DIR"

# Set up bundled binaries in PATH
export PATH="$BIN_DIR:$PATH"

# Configure Colima environment
export COLIMA_HOME="$COLIMA_HOME"
export LIMA_HOME="$COLIMA_HOME/_lima"
export LIMA_INSTANCE="onionpress"
export DOCKER_HOST="unix://$COLIMA_HOME/default/docker.sock"

# Log file
LOG_FILE="$DATA_DIR/launcher.log"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Function to update initialization status (shown as notification)
update_status() {
    log "Status: $1"
    osascript -e "display notification \"$1\" with title \"Onion.Press Setup\"" 2>/dev/null || true
}

log "Starting onion.press launcher..."

# Check for Python 3
if ! command -v python3 >/dev/null 2>&1; then
    log "ERROR: Python 3 not found"
    osascript <<EOF
tell current application
    activate
    display dialog "Python 3 is required to run onion.press but was not found.

macOS 12.3+ removed Python 2. Please install Python 3 from:
https://www.python.org/downloads/

Or install via Homebrew:
brew install python3" buttons {"OK"} default button "OK" with icon stop with title "onion.press Error"
end tell
EOF
    exit 1
fi

log "Python 3 found: $(python3 --version)"

# Check if this is first-time initialization
FIRST_RUN=false
if [ ! -d "$VENV_DIR" ] || [ ! -f "$COLIMA_HOME/.initialized" ]; then
    FIRST_RUN=true
    log "First-time initialization detected"

    # Open Console.app to show progress
    open -a Console "$LOG_FILE"
    log "Console.app opened to show setup progress"

    # Show setup dialog in background (non-blocking)
    # Setup will proceed regardless of user interaction with the dialog
    ICON_PATH="$RESOURCES_DIR/app-icon.png"
    osascript <<EOF >/dev/null 2>&1 &
tell current application
    activate
    display dialog "First-time setup in progress (2-3 minutes):

• Setting up Python environment
• Initializing container runtime
• Downloading Docker images

Console.app has been opened so you can watch the progress.

You can dismiss this dialog - setup will continue in the background." buttons {"OK"} default button "OK" with icon POSIX file "$ICON_PATH" with title "Onion.Press Setup" giving up after 180
end tell
EOF

    log "Proceeding with first-time setup (dialog shown in background)"
fi

# Create virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    log "Creating Python virtual environment..."

    # Show progress dialog
    osascript -e 'display notification "Setting up Python environment..." with title "Onion.Press Setup"' &

    python3 -m venv "$VENV_DIR" >> "$LOG_FILE" 2>&1

    osascript -e 'display notification "Installing Python dependencies (1-2 min)..." with title "Onion.Press Setup"' &

    "$VENV_DIR/bin/pip" install --upgrade pip >> "$LOG_FILE" 2>&1
    "$VENV_DIR/bin/pip" install -r "$SCRIPTS_DIR/requirements.txt" >> "$LOG_FILE" 2>&1

    osascript -e 'display notification "Python setup complete!" with title "Onion.Press Setup"' &

    log "Virtual environment created successfully"
fi

# Initialize Colima on first run
initialize_colima() {
    if [ ! -f "$COLIMA_HOME/.initialized" ]; then
        log "Initializing Colima container runtime..."

        # Show progress notification
        osascript -e 'display notification "Initializing container runtime (1-2 min)..." with title "Onion.Press Setup"' &

        # Check macOS version >= 13
        MACOS_VERSION=$(sw_vers -productVersion | cut -d '.' -f 1)
        if [ "$MACOS_VERSION" -lt 13 ]; then
            log "ERROR: macOS 13+ required"
            osascript <<EOF
tell current application
    activate
    display dialog "onion.press requires macOS 13 (Ventura) or later.

Your macOS version: $(sw_vers -productVersion)

The bundled container runtime uses Apple's virtualization framework which requires macOS 13+." buttons {"OK"} default button "OK" with icon stop with title "onion.press Error"
end tell
EOF
            exit 1
        fi

        # Initialize Colima with VZ backend
        "$BIN_DIR/colima" start \
            --vm-type vz \
            --mount-type virtiofs \
            --cpu 2 \
            --memory 4 \
            --disk 60 \
            --arch aarch64 \
            --network-address \
            >> "$LOG_FILE" 2>&1

        if [ $? -eq 0 ]; then
            touch "$COLIMA_HOME/.initialized"
            log "Colima initialized successfully"
            osascript -e 'display notification "Container runtime ready!" with title "Onion.Press Setup"' &
        else
            log "ERROR: Colima init failed"
            osascript <<EOF
tell current application
    activate
    display dialog "Failed to initialize container runtime.

Check the logs for details:
$LOG_FILE" buttons {"OK"} default button "OK" with icon stop with title "onion.press Error"
end tell
EOF
            exit 1
        fi
    fi

    # Ensure Colima is running
    if ! "$BIN_DIR/colima" status >/dev/null 2>&1; then
        log "Starting Colima VM..."
        "$BIN_DIR/colima" start >> "$LOG_FILE" 2>&1
    fi
}

# Launch menubar app in background if first run (so icon appears immediately)
# The menubar app will show gray icon and wait for services to be ready
if [ "$FIRST_RUN" = true ]; then
    log "Launching menu bar application in background during setup..."
    cd "$SCRIPTS_DIR"

    # Use pythonw if available (for GUI apps on macOS), otherwise use python3
    if [ -f "$VENV_DIR/bin/pythonw" ] || [ -f "$VENV_DIR/bin/pythonw3" ]; then
        PYTHON_CMD="$VENV_DIR/bin/pythonw"
    else
        PYTHON_CMD="$VENV_DIR/bin/python3"
    fi

    # Launch menubar in background so setup can continue
    export PYTHONPATH="$SCRIPTS_DIR"
    "$PYTHON_CMD" "$SCRIPTS_DIR/menubar.py" >> "$LOG_FILE" 2>&1 &
    MENUBAR_PID=$!
    log "Menu bar app launched (PID: $MENUBAR_PID)"
fi

# Run initialization (menubar is now visible with gray icon during this)
initialize_colima

# Create symlink for Docker socket if needed
# Colima forwards the socket to ~/.colima/default/docker.sock
# but we configure DOCKER_HOST to use ~/.onion.press/colima/default/docker.sock
# Create symlink to bridge this gap
SOCKET_DIR="$COLIMA_HOME/default"
SOCKET_PATH="$SOCKET_DIR/docker.sock"
COLIMA_SOCKET="$HOME/.colima/default/docker.sock"

if [ -S "$COLIMA_SOCKET" ]; then
    if [ ! -e "$SOCKET_PATH" ] || [ ! -S "$SOCKET_PATH" ]; then
        log "Creating Docker socket symlink..."
        mkdir -p "$SOCKET_DIR"
        ln -sf "$COLIMA_SOCKET" "$SOCKET_PATH"
        log "Docker socket symlink created: $SOCKET_PATH -> $COLIMA_SOCKET"
    fi
fi

# Show completion notification if first run
if [ "$FIRST_RUN" = true ]; then
    osascript -e 'display notification "Setup complete! Menu bar app is ready." with title "Onion.Press Setup"' &
    log "Setup complete - menu bar app already running"
    exit 0
fi

# For subsequent launches, start menu bar app normally
log "Launching menu bar application..."
cd "$SCRIPTS_DIR"

# Use pythonw if available (for GUI apps on macOS), otherwise use python3
if [ -f "$VENV_DIR/bin/pythonw" ] || [ -f "$VENV_DIR/bin/pythonw3" ]; then
    PYTHON_CMD="$VENV_DIR/bin/pythonw"
else
    # Create a proper GUI context by using the Python framework
    PYTHON_CMD="$VENV_DIR/bin/python3"
fi

# Launch with proper environment
export PYTHONPATH="$SCRIPTS_DIR"
"$PYTHON_CMD" "$SCRIPTS_DIR/menubar.py" >> "$LOG_FILE" 2>&1
